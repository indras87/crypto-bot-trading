<!-- Content -->
<div class="p-4">
    <div class="max-w-[1800px] mx-auto">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-semibold">Order: <%= profilePair %></h1>
            <nav class="text-[13px] text-gray-500">
                <a href="/" class="text-blue-600 hover:underline">Dashboard</a> /
                <a href="/orders" class="text-blue-600 hover:underline">Orders</a> /
                <%= profilePair %>
            </nav>
        </div>

        <% if (typeof pairErrors !== 'undefined' && pairErrors.length > 0) { %>
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                <div class="font-medium mb-2"><i class="fas fa-triangle-exclamation"></i> Errors loading pairs:</div>
                <ul class="text-sm list-disc list-inside">
                    <% pairErrors.forEach(function(err) { %>
                        <li><%= err %></li>
                    <% }); %>
                </ul>
            </div>
        <% } %>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                <i class="fas fa-circle-exclamation"></i> <%= error %>
            </div>
        <% } %>

        <div class="flex gap-4">
            <!-- Left: Pairs list -->
            <div class="w-80 shrink-0 bg-white border border-gray-200 rounded">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                    <span class="font-medium">Pairs (<%= allPairs.length %>)</span>
                </div>
                <div class="px-4 py-2 border-b border-gray-200">
                    <input type="text" id="pair-filter" placeholder="Filter..." class="w-full border border-gray-300 rounded px-3 py-1.5 text-[13px]">
                </div>
                <div id="pairs-list" class="max-h-[calc(100vh-380px)] overflow-y-auto">
                    <% if (allPairs && allPairs.length > 0) { %>
                        <% allPairs.forEach(function(item) { %>
                            <a href="/orders/<%= item.profileId %>/<%= encodeURIComponent(item.pair) %>"
                               class="pair-item flex items-center justify-between px-4 py-2 hover:bg-gray-50 border-b border-gray-100 <%= item.profileId === profile.id && item.pair === pair ? 'bg-blue-50' : '' %>"
                               data-search="<%= item.profileName.toLowerCase() %> <%= item.pair.toLowerCase() %>">
                                <div class="truncate">
                                    <span class="text-gray-500"><%= item.profileName %>:</span><%= item.pair %>
                                </div>
                                <%- getTypeBadge(item.type) %>
                            </a>
                        <% }); %>
                    <% } else { %>
                        <div class="px-4 py-4 text-center text-gray-500 text-sm">
                            No pairs found.
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Middle: Order Form -->
            <div class="w-100 shrink-0">

                <!-- Ticker -->
                <% if (ticker) { %>
                    <div class="bg-blue-500 text-white rounded p-4">
                        <h3 class="text-2xl font-bold"><%= priceFormat(ticker.ask) %> / <%= priceFormat(ticker.bid) %></h3>
                        <p class="text-sm">Ask / Bid<%= ticker.last ? ' (Last: ' + priceFormat(ticker.last) + ')' : '' %></p>
                    </div>
                <% } %>

                <div class="bg-white border border-gray-200 rounded">
                    <form action="/orders/<%= profile.id %>/<%= encodeURIComponent(pair) %>" method="post">
                        <div class="p-4">
                            <% if (typeof alert !== 'undefined' && alert) { %>
                                <%- include('../components/alert', {alert: alert}) %>
                            <% } %>

                            <div class="flex gap-4 mb-4">
                                <div class="w-28">
                                    <label for="order_type" class="block font-medium mb-1 text-sm">Type</label>
                                    <select class="w-full border border-gray-300 rounded px-3 py-2 text-sm" id="order_type" name="type">
                                        <option value="limit" <%= (!form || !form.type || form.type === 'limit') ? 'selected' : '' %>>Limit</option>
                                        <option value="market" <%= form && form.type === 'market' ? 'selected' : '' %>>Market</option>
                                    </select>
                                </div>
                            </div>

                            <div id="price-group" class="<%= form && form.type === 'market' ? 'hidden' : '' %>">
                                <label for="price" class="block font-medium mb-1 text-sm">Price</label>
                                <div class="flex">
                                    <input type="text" class="flex-1 border border-gray-300 rounded-l px-3 py-2 text-sm" id="price" placeholder="Price" name="price" value="<%= form && form.price ? form.price : (ticker ? ticker.bid : '') %>">
                                    <div class="flex percent-input-group">
                                        <button class="px-2 py-2 border border-l-0 border-gray-300 bg-gray-50 text-xs hover:bg-gray-100 cursor-pointer" type="button" value="0.5">+0.5%</button>
                                        <button class="px-2 py-2 border border-l-0 border-gray-300 bg-gray-50 text-xs hover:bg-gray-100 cursor-pointer" type="button" value="1">+1%</button>
                                        <button class="px-2 py-2 border border-l-0 border-gray-300 bg-gray-50 text-xs hover:bg-gray-100 cursor-pointer" type="button" value="-0.5">-0.5%</button>
                                        <button class="px-2 py-2 border border-l-0 border-gray-300 bg-gray-50 text-xs rounded-r hover:bg-gray-100 cursor-pointer" type="button" value="-1">-1%</button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4 mt-4">
                                <div class="flex-1">
                                    <label for="amount" class="block font-medium mb-1 text-sm">Amount</label>
                                    <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" id="amount" name="amount" value="<%= form && form.amount ? form.amount : '' %>" required>
                                </div>
                                <div class="w-28">
                                    <label for="amount_type" class="block font-medium mb-1 text-sm">In</label>
                                    <select class="w-full border border-gray-300 rounded px-3 py-2 text-sm" id="amount_type" name="amount_type">
                                        <option value="currency" <%= !form || !form.amount_type || form.amount_type === 'currency' ? 'selected' : '' %>><%= currency %></option>
                                        <option value="asset" <%= form && form.amount_type === 'asset' ? 'selected' : '' %>><%= asset %></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 py-3 border-t border-gray-200 flex gap-2">
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 cursor-pointer text-sm" name="side" value="buy"><i class="fas fa-cart-shopping"></i> Buy</button>
                            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 cursor-pointer text-sm" name="side" value="sell"><i class="fas fa-trash-can"></i> Sell</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right: Orders + Chart -->
            <div class="flex-1">
                <!-- Orders List (lazy loaded) -->
                <div class="bg-white border border-gray-200 rounded mb-4">
                    <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                        <span class="font-medium">Open Orders <span id="orders-count" class="text-gray-400"></span></span>
                        <div class="flex items-center gap-2">
                            <button id="refresh-orders" class="text-gray-400 hover:text-blue-600 cursor-pointer" title="Refresh Orders">
                                <i class="fas fa-arrows-rotate"></i>
                            </button>
                            <a href="/orders/<%= profile.id %>/<%= encodeURIComponent(pair) %>/cancel-all" class="text-gray-400 hover:text-red-600" title="Cancel All" onclick="return confirm('Cancel all orders?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                    <div id="orders-content">
                        <div class="p-4 text-gray-500 text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading orders...
                        </div>
                    </div>
                </div>

                <!-- TradingView Chart -->
                <div class="bg-white border border-gray-200 rounded">
                    <div class="p-4">
                        <div id="tradingview" style="width: 100%; height: 400px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<% function getTypeBadge(type) { %>
    <% if (type === 'spot') { %>
        <span class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-xs shrink-0">Spot</span>
    <% } else if (type === 'margin') { %>
        <span class="bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-xs shrink-0">Margin</span>
    <% } else if (type === 'swap' || type === 'future_perp') { %>
        <span class="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded text-xs shrink-0">Future (Perp)</span>
    <% } else if (type === 'future' || type === 'future_dated') { %>
        <span class="bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-xs shrink-0">Future (Dated)</span>
    <% } else { %>
        <span class="text-gray-400">-</span>
    <% } %>
<% } %>

<script src="/js/orders.js?v=<%= assetVersion %>"></script>
<script src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    new TradingView.widget({
        "autosize": true,
        "symbol": "<%= tradingview %>",
        "interval": "15",
        "theme": "Light",
        "style": "60",
        "locale": "en",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "allow_symbol_change": true,
        "container_id": "tradingview",
        "timezone": Intl.DateTimeFormat().resolvedOptions().timeZone,
        "studies": [
            "BB@tv-basicstudies",
            "MACD@tv-basicstudies",
            "MAExp@tv-basicstudies",
            "RSI@tv-basicstudies",
        ],
    });

    // Filter functionality
    document.getElementById('pair-filter')?.addEventListener('input', function(e) {
        const filter = e.target.value.toLowerCase();
        document.querySelectorAll('.pair-item').forEach(function(item) {
            const search = item.getAttribute('data-search') || '';
            item.style.display = search.includes(filter) ? '' : 'none';
        });
    });
</script>
