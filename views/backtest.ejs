<!-- Backtest Form -->
<div class="p-3 md:p-4">
    <div class="max-w-4xl mx-auto">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-4">
            <h1 class="text-xl md:text-2xl font-semibold">Backtesting</h1>
            <nav class="text-sm text-gray-500">
                <a href="/" class="text-blue-600 hover:underline">Dashboard</a> /
                <a href="/backtest" class="text-blue-600 hover:underline">Backtesting</a>
            </nav>
        </div>

        <div class="bg-white border border-gray-200 rounded">
            <div class="p-4 md:p-6">
                <form action="/backtest/submit" method="post" class="backtest-v2-form" data-async-endpoint="/api/backtest/jobs">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                        <div class="space-y-4">
                            <div>
                                <label for="form-pair" class="block font-medium mb-1">Pair</label>
                                <select class="w-full" id="form-pair" name="pair" data-slim-select data-slim-placeholder="Search or select a pair..." required>
                                    <option disabled selected value> -- select a pair -- </option>
                                    <% pairs.forEach(function(pair) { %>
                                        <option value="<%= pair.name %>"><%= pair.displayName %></option>
                                    <% }); %>
                                </select>
                            </div>

                            <div>
                                <label for="form-strategy" class="block font-medium mb-1">Strategy</label>
                                <select class="w-full border border-gray-300 rounded px-3 py-2" id="form-strategy" name="strategy" required>
                                    <option disabled selected value> -- select a strategy -- </option>
                                    <% strategies.forEach(function(strategy) { %>
                                        <option value="<%= strategy.name %>"><%= strategy.displayName %></option>
                                    <% }); %>
                                </select>
                                <p class="text-xs text-gray-500 mt-1" id="strategy-description"></p>
                            </div>

                            <div>
                                <label for="form-candle-period" class="block font-medium mb-1">Candle Period</label>
                                <select class="w-full border border-gray-300 rounded px-3 py-2" id="form-candle-period" name="candle_period" required>
                                    <% periods.forEach(function(period) { %>
                                        <option value="<%= period %>" <%= period === '15m' ? 'selected' : '' %>><%= period %></option>
                                    <% }); %>
                                </select>
                            </div>

                            <div class="flex items-center space-x-2 py-2">
                                <input type="checkbox" id="form-use-ai" name="use_ai" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="form-use-ai" class="text-sm font-medium text-gray-700">Filter signals with AI (Signal Validation)</label>
                            </div>

                            <div>
                                <label for="form-hours" class="block font-medium mb-1">Backtest Duration (Hours)</label>
                                <input class="w-full border border-gray-300 rounded px-3 py-2" id="form-hours" name="hours" value="168" required>
                                <div class="flex gap-2 mt-2 flex-wrap">
                                    <button type="button" class="preset-hours-btn text-xs px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 cursor-pointer" data-hours="24">1 Day</button>
                                    <button type="button" class="preset-hours-btn text-xs px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 cursor-pointer" data-hours="168">7 Days</button>
                                    <button type="button" class="preset-hours-btn text-xs px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 cursor-pointer" data-hours="720">30 Days</button>
                                    <button type="button" class="preset-hours-btn text-xs px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 cursor-pointer" data-hours="2160">90 Days</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Hours from now (168 = 7 days, 720 = 30 days). Historical data will be fetched automatically if not in DB.</p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="form-stop-loss" class="block font-medium mb-1 text-red-600">Stop Loss (%)</label>
                                    <input type="number" step="0.1" class="w-full border border-gray-300 rounded px-3 py-2" id="form-stop-loss" placeholder="e.g. 2.0">
                                </div>
                                <div>
                                    <label for="form-take-profit" class="block font-medium mb-1 text-green-600">Take Profit (%)</label>
                                    <input type="number" step="0.1" class="w-full border border-gray-300 rounded px-3 py-2" id="form-take-profit" placeholder="e.g. 5.0">
                                </div>
                            </div>

                            <div>
                                <label for="form-initial-capital" class="block font-medium mb-1">Initial Capital</label>
                                <input class="w-full border border-gray-300 rounded px-3 py-2" id="form-initial-capital" name="initial_capital" value="1000" required>
                                <p class="text-xs text-gray-500 mt-1">Starting capital for profit calculations</p>
                            </div>

                            <div>
                                <label for="form-options" class="block font-medium mb-1">Strategy Options (JSON)</label>
                                <textarea class="w-full border border-gray-300 rounded px-3 py-2 font-mono text-sm" id="form-options" rows="6" name="options" placeholder='{"option": "value"}'></textarea>
                                <p class="text-xs text-gray-500 mt-1">Optional: Override default strategy options</p>
                            </div>
                        </div>
                    </div>

                    <button id="run-backtest-btn" type="submit" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 cursor-pointer w-full sm:w-auto">
                        Run Backtest
                    </button>
                    <div class="flex items-center mt-3">
                        <input type="checkbox" id="form-save-high-winrate" name="save_high_winrate" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="form-save-high-winrate" class="ml-2 text-sm text-gray-700">Save only if Win Rate â‰¥ 60%</label>
                    </div>
                </form>
                <div id="job-progress-panel" class="mt-4 hidden border border-blue-200 bg-blue-50 rounded p-3">
                    <div class="text-sm font-medium text-blue-900">Backtest sedang berjalan...</div>
                    <div id="job-progress-message" class="text-xs text-blue-700 mt-1">Mengantri</div>
                    <div class="w-full bg-blue-100 rounded h-2 mt-3">
                        <div id="job-progress-bar" class="bg-blue-600 h-2 rounded transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Strategy data for dynamic updates
const strategyData = {
    <% strategies.forEach(function(strategy) { %>
        '<%= strategy.name %>': {
            description: '<%= strategy.description %>',
            defaultOptions: <%- JSON.stringify(strategy.defaultOptions, null, 2) %>
        },
    <% }); %>
};

// Update strategy description and default options on selection
document.getElementById('form-strategy').addEventListener('change', function() {
    const data = strategyData[this.value];
    const descEl = document.getElementById('strategy-description');
    const optionsEl = document.getElementById('form-options');
    const slEl = document.getElementById('form-stop-loss');
    const tpEl = document.getElementById('form-take-profit');

    if (data) {
        descEl.textContent = data.description;
        optionsEl.value = JSON.stringify(data.defaultOptions, null, 2);
        
        // Fill SL/TP inputs if they exist in defaults
        slEl.value = data.defaultOptions.stop_loss || '';
        tpEl.value = data.defaultOptions.take_profit || '';
    } else {
        descEl.textContent = '';
        optionsEl.value = '';
        slEl.value = '';
        tpEl.value = '';
    }
});

// Sync SL/TP inputs back to JSON
function syncOptions() {
    const optionsEl = document.getElementById('form-options');
    const slValue = document.getElementById('form-stop-loss').value;
    const tpValue = document.getElementById('form-take-profit').value;
    
    try {
        let options = JSON.parse(optionsEl.value || '{}');
        if (slValue) options.stop_loss = parseFloat(slValue);
        else delete options.stop_loss;
        
        if (tpValue) options.take_profit = parseFloat(tpValue);
        else delete options.take_profit;
        
        optionsEl.value = JSON.stringify(options, null, 2);
    } catch (e) {
        // ignore if JSON is currently invalid
    }
}

document.getElementById('form-stop-loss').addEventListener('input', syncOptions);
document.getElementById('form-take-profit').addEventListener('input', syncOptions);

// Preset duration buttons
document.querySelectorAll('.preset-hours-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.getElementById('form-hours').value = this.dataset.hours;
    });
});

const backtestForm = document.querySelector('.backtest-v2-form');
const progressPanel = document.getElementById('job-progress-panel');
const progressBar = document.getElementById('job-progress-bar');
const progressMessage = document.getElementById('job-progress-message');
const runButton = document.getElementById('run-backtest-btn');

function setProgress(percent, message) {
    progressBar.style.width = Math.max(0, Math.min(100, percent)) + '%';
    progressMessage.textContent = message || 'Memproses...';
}

async function pollJob(statusUrl, resultUrl) {
    const timer = setInterval(async function() {
        try {
            const res = await fetch(statusUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) {
                throw new Error('Gagal mengambil status job');
            }
            const data = await res.json();
            setProgress(data.progressPercent || 0, data.message || 'Memproses...');

            if (data.status === 'done') {
                clearInterval(timer);
                window.location.href = resultUrl || data.resultUrl;
                return;
            }
            if (data.status === 'failed') {
                clearInterval(timer);
                runButton.disabled = false;
                runButton.classList.remove('opacity-50', 'cursor-not-allowed');
                setProgress(data.progressPercent || 0, data.error || 'Backtest gagal');
            }
        } catch (error) {
            clearInterval(timer);
            runButton.disabled = false;
            runButton.classList.remove('opacity-50', 'cursor-not-allowed');
            setProgress(0, error instanceof Error ? error.message : 'Terjadi kesalahan saat polling status');
        }
    }, 1000);
}

backtestForm.addEventListener('submit', async function(event) {
    event.preventDefault();
    runButton.disabled = true;
    runButton.classList.add('opacity-50', 'cursor-not-allowed');
    progressPanel.classList.remove('hidden');
    setProgress(2, 'Mengirim request backtest...');

    try {
        const formData = new FormData(backtestForm);
        const body = new URLSearchParams();
        formData.forEach(function(value, key) {
            body.append(key, String(value));
        });

        const res = await fetch(backtestForm.dataset.asyncEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body
        });
        if (!res.ok) {
            const data = await res.json().catch(function() { return {}; });
            throw new Error(data.error || 'Gagal membuat job backtest');
        }
        const data = await res.json();
        setProgress(5, 'Job dibuat, menunggu eksekusi...');
        pollJob(data.statusUrl, data.resultUrl);
    } catch (error) {
        runButton.disabled = false;
        runButton.classList.remove('opacity-50', 'cursor-not-allowed');
        setProgress(0, error instanceof Error ? error.message : 'Terjadi kesalahan');
    }
});
</script>
