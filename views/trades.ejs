<!-- Content -->
<div class="p-4">
    <div class="max-w-[1800px] mx-auto">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-semibold">Trades</h1>
            <div class="flex items-center gap-4">
                <form method="get" action="/trades">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Reload
                    </button>
                </form>
                <nav class="text-sm text-gray-500">
                    <a href="/" class="text-blue-600 hover:underline">Dashboard</a> / Trades
                </nav>
            </div>
        </div>

        <!-- Positions Table (Swap / Futures via CCXT profiles) -->
        <div class="bg-white overflow-x-auto mb-4">
            <div class="px-4 py-3 border-b-2 border-gray-300 flex justify-between items-center">
                <span class="text-lg font-semibold">Positions (<%= profilePositions.length %>)</span>
                <span class="text-gray-500 text-[13px]"><%= updatedAt %></span>
            </div>

            <% if (profilePositions.length > 0) { %>
            <table class="w-full border-collapse text-[13px]">
                <thead>
                <tr>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Profile</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Symbol</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2" title="Side">Side</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Contracts</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Entry</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Mark</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Notional</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Unreal. PnL</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Liq. Price</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Lev.</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Margin</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2" title="Action">A</th>
                </tr>
                </thead>
                <tbody>
                <% profilePositions.forEach(function(item) { %>
                <tr class="hover:bg-gray-100">
                    <td class="border border-gray-200 px-3 py-2 text-gray-600">
                        <img src="/img/exchanges/<%= item.exchange %>.png" alt="<%= item.exchange %>" title="<%= item.exchange %>" width="16" height="16" class="inline-block mr-1">
                        <%= item.profileName %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono">
                        <%= item.position.symbol %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2">
                        <% if (item.position.side === 'short') { %>
                            <span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-800"><i class="fas fa-chevron-down mr-1"></i>short</span>
                        <% } else if (item.position.side === 'long') { %>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-800"><i class="fas fa-chevron-up mr-1"></i>long</span>
                        <% } else { %>
                            <span class="text-gray-400"><%= item.position.side %></span>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <%= item.position.contracts %>
                        <% if (item.position.contractSize && item.position.contractSize !== 1) { %>
                            <span class="text-gray-400 text-[11px]">×<%= item.position.contractSize %></span>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <% if (item.position.entryPrice != null) { %>
                            <%= item.position.entryPrice < 1 ? item.position.entryPrice.toFixed(6) : item.position.entryPrice.toFixed(2) %>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <% if (item.position.markPrice != null) { %>
                            <%= item.position.markPrice < 1 ? item.position.markPrice.toFixed(6) : item.position.markPrice.toFixed(2) %>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <% if (item.position.notional != null) { %>
                            <%= Math.abs(item.position.notional) < 1 ? Math.abs(item.position.notional).toFixed(6) : Math.abs(item.position.notional).toFixed(2) %>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <% if (item.position.unrealizedPnl != null) { %>
                            <span class="<%= item.position.unrealizedPnl >= 0 ? 'text-green-600' : 'text-red-600' %>">
                                <%= item.position.unrealizedPnl >= 0 ? '+' : '' %><%= item.position.unrealizedPnl.toFixed(4) %>
                                <% if (item.position.percentage != null) { %>
                                    <span class="text-[11px] opacity-75">(<%= item.position.percentage.toFixed(2) %>%)</span>
                                <% } %>
                            </span>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right text-orange-600">
                        <% if (item.position.liquidationPrice != null) { %>
                            <%= item.position.liquidationPrice < 1 ? item.position.liquidationPrice.toFixed(6) : item.position.liquidationPrice.toFixed(2) %>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 text-right text-gray-600">
                        <% if (item.position.leverage != null) { %>
                            <%= item.position.leverage %>×
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 text-gray-500">
                        <% if (item.position.marginMode) { %>
                            <span class="px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-600"><%= item.position.marginMode %></span>
                        <% } %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 whitespace-nowrap">
                        <form method="post" action="/position/<%= item.profileId %>/close" class="inline">
                            <input type="hidden" name="symbol" value="<%= encodeURIComponent(item.position.symbol) %>">
                            <button type="submit" name="type" value="limit"
                                class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800 hover:bg-yellow-200 mr-1"
                                title="Limit Close at best bid/ask"
                                onclick="return confirm('Limit close <%= item.position.contracts %> <%= item.position.symbol %>?')">
                                Limit
                            </button>
                            <button type="submit" name="type" value="market"
                                class="text-xs px-2 py-1 rounded bg-red-100 text-red-800 hover:bg-red-200"
                                title="Market Close"
                                onclick="return confirm('Market close <%= item.position.contracts %> <%= item.position.symbol %>?')">
                                Market
                            </button>
                        </form>
                    </td>
                </tr>
                <% }); %>
                </tbody>
            </table>
            <% } else { %>
            <div class="p-4 text-center text-gray-400">No open positions</div>
            <% } %>
        </div>

        <!-- Orders Table -->
        <div class="bg-white overflow-x-auto">
            <div class="px-4 py-3 border-b-2 border-gray-300 flex justify-between items-center">
                <span class="text-lg font-semibold">Open Orders (<%= openOrders.length %>)</span>
                <span class="text-gray-500 text-[13px]"><%= updatedAt %></span>
            </div>

            <% if (openOrders.length > 0) { %>
            <table class="w-full border-collapse text-[13px]">
                <thead>
                <tr>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Profile</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Symbol</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Side</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Type</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Price</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Amount</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Filled</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Status</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2">Date</th>
                    <th class="border border-gray-200 bg-gray-50 font-semibold px-3 py-2" title="Action">A</th>
                </tr>
                </thead>
                <tbody>
                <% openOrders.forEach(function(item) { %>
                <tr class="hover:bg-gray-100">
                    <td class="border border-gray-200 px-3 py-2">
                        <span class="text-gray-600"><%= item.profileName %></span>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono">
                        <%= item.order.pair %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2">
                        <span class="px-2 py-0.5 rounded text-xs <%= item.order.side === 'buy' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                            <%= item.order.side %>
                        </span>
                    </td>
                    <td class="border border-gray-200 px-3 py-2">
                        <span class="px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-700">
                            <%= item.order.type %>
                        </span>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <%= item.order.price < 0.01 ? item.order.price.toFixed(8) : item.order.price.toFixed(2) %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right">
                        <%= item.order.amount.toFixed(6) %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 font-mono text-right text-gray-500">
                        <%= item.order.filled.toFixed(6) %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2">
                        <span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-800">
                            <%= item.order.status %>
                        </span>
                    </td>
                    <td class="border border-gray-200 px-3 py-2 text-gray-500">
                        <%= item.order.timestamp ? new Date(item.order.timestamp).toLocaleString() : '-' %>
                    </td>
                    <td class="border border-gray-200 px-3 py-2">
                        <a title="cancel" href="/order/<%= item.profileId %>/<%= encodeURIComponent(item.order.pair) %>/<%= item.order.id %>" class="text-gray-600 hover:text-red-600"><i class="fas fa-window-close"></i></a>
                    </td>
                </tr>
                <% }); %>
                </tbody>
            </table>
            <% } else { %>
            <div class="p-4 text-center text-gray-400">No open orders</div>
            <% } %>
        </div>
    </div>
</div>
